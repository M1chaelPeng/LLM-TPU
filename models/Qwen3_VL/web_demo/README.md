# Qwen3-VL Web Demo

åŸºäº Gradio çš„ Qwen3-VL å¤šæ¨¡æ€å¤§æ¨¡å‹ Web ç•Œé¢ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡å’Œè§†é¢‘çš„æ™ºèƒ½å¯¹è¯ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸ“ **çº¯æ–‡æœ¬å¯¹è¯** - è‡ªç„¶è¯­è¨€é—®ç­”
- ğŸ–¼ï¸ **å›¾ç‰‡ç†è§£** - æ”¯æŒå›¾ç‰‡å†…å®¹åˆ†æå’Œé—®ç­”
- ğŸ¥ **è§†é¢‘åˆ†æ** - æ”¯æŒè§†é¢‘å†…å®¹ç†è§£
- ğŸ’¬ **å¤šè½®å¯¹è¯** - æ”¯æŒå¯¹è¯å†å²è®°å½•
- ğŸ“Š **æ€§èƒ½ç›‘æ§** - å®æ—¶æ˜¾ç¤º FTLã€TPSã€è§†è§‰å¤„ç†æ—¶é—´
- ğŸŒ **Web ç•Œé¢** - å‹å¥½çš„ Gradio äº¤äº’ç•Œé¢

## ç¯å¢ƒè¦æ±‚

### ç¡¬ä»¶
- Sophgo BM1684X æˆ– BM1688 (CV186X) TPU
- å»ºè®®å†…å­˜ >= 8GB

### è½¯ä»¶
- Python >= 3.10
- TPU é©±åŠ¨ >= 0.5.1
- libsophon (æœ€æ–°ç‰ˆæœ¬)

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd models/Qwen3_VL/web_demo
pip3 install -r requirements.txt
```

### 2. ç¼–è¯‘ Runtime æ¨¡å—

Web Demo ä¾èµ–äº `python_demo` ä¸­çš„ç¼–è¯‘æ¨¡å—ï¼Œéœ€è¦å…ˆç¼–è¯‘ï¼š

```bash
cd ../python_demo
mkdir -p build
cd build
cmake .. && make
cp *cpython* ..
cd ../..
```

**æ³¨æ„**ï¼šå¦‚æœé‡åˆ° pybind11 ç›¸å…³é”™è¯¯ï¼Œè¯·å…ˆå®‰è£…ï¼š
```bash
pip3 install pybind11
```

### 3. å‡†å¤‡æ¨¡å‹

#### æ–¹å¼ Aï¼šä¸‹è½½é¢„ç¼–è¯‘æ¨¡å‹ï¼ˆæ¨èï¼‰

```bash
# BM1684X 4B æ¨¡å‹
python3 -m dfss --url=open@sophgo.com:/ext_model_information/LLM/LLM-TPU/qwen3-vl-4b-instruct_w4bf16_seq2048_bm1684x_1dev_20251026_141347.bmodel

# BM1684X 8B æ¨¡å‹
python3 -m dfss --url=open@sophgo.com:/ext_model_information/LLM/LLM-TPU/qwen3-vl-8b-instruct_w4bf16_seq2048_bm1684x_1dev_20251026_145323.bmodel

# BM1688 4B æ¨¡å‹
python3 -m dfss --url=open@sophgo.com:/ext_model_information/LLM/LLM-TPU_Lite/qwen3-vl-4b-instruct_w4bf16_seq2048_bm1688_2core_20251026_141708.bmodel
```

#### æ–¹å¼ Bï¼šè‡ªå·±ç¼–è¯‘æ¨¡å‹

å‚è€ƒ [Qwen3-VL README](../README.md) ä¸­çš„ç¼–è¯‘è¯´æ˜ã€‚

### 4. å¯åŠ¨ Web Demo

#### æ–¹å¼ Aï¼šä½¿ç”¨å¯åŠ¨è„šæœ¬ï¼ˆæ¨èï¼‰

```bash
cd models/Qwen3_VL/web_demo

# è®¾ç½®æ¨¡å‹è·¯å¾„å¹¶å¯åŠ¨
export BMODEL_PATH=/path/to/qwen3-vl-4b-instruct_xxx.bmodel
./run_demo.sh
```

#### æ–¹å¼ Bï¼šç›´æ¥è¿è¡Œ Python è„šæœ¬

```bash
cd models/Qwen3_VL/web_demo

python3 web_demo_gradio.py \
    --model_path /path/to/model.bmodel \
    --config_path ../config \
    --devid 0 \
    --video_ratio 0.25 \
    --server_port 7860
```

### 5. è®¿é—® Web ç•Œé¢

å¯åŠ¨æˆåŠŸåï¼Œåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ï¼š
- æœ¬åœ°è®¿é—®ï¼š`http://localhost:7860`
- è¿œç¨‹è®¿é—®ï¼š`http://<æœåŠ¡å™¨IP>:7860`

å¦‚æœä½¿ç”¨äº† `--inbrowser` å‚æ•°ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€ã€‚

## ä½¿ç”¨è¯´æ˜

### ç•Œé¢å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Qwen3-VL TPU Multi-Modal Demo          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å¯¹è¯å†å²åŒºåŸŸ]                          â”‚
â”‚  - æ˜¾ç¤ºç”¨æˆ·å’Œ AI çš„å¯¹è¯                  â”‚
â”‚  - æ”¯æŒæ˜¾ç¤ºä¸Šä¼ çš„å›¾ç‰‡                    â”‚
â”‚  - æµå¼æ˜¾ç¤º AI å›å¤                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡æœ¬è¾“å…¥: [_________________]           â”‚
â”‚  å›¾ç‰‡ä¸Šä¼ : [Choose File]                â”‚
â”‚  è§†é¢‘ä¸Šä¼ : [Choose File]                â”‚
â”‚  [å‘é€] [æ¸…ç©ºå¯¹è¯]                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ€§èƒ½æŒ‡æ ‡:                               â”‚
â”‚  - é¦–Tokenå»¶è¿Ÿ (FTL)                    â”‚
â”‚  - ç”Ÿæˆé€Ÿåº¦ (TPS)                        â”‚
â”‚  - è§†è§‰å¤„ç†æ—¶é—´                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. çº¯æ–‡æœ¬å¯¹è¯
```
ç”¨æˆ·: è¯·ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†å²
AI: [æµå¼è¾“å‡ºå›ç­”...]
```

#### 2. å›¾ç‰‡é—®ç­”
```
æ­¥éª¤ 1: ä¸Šä¼ ä¸€å¼ å›¾ç‰‡
æ­¥éª¤ 2: è¾“å…¥é—®é¢˜ï¼Œå¦‚"è¯·æè¿°è¿™å¼ å›¾ç‰‡çš„å†…å®¹"
æ­¥éª¤ 3: ç‚¹å‡»å‘é€
```

#### 3. è§†é¢‘åˆ†æ
```
æ­¥éª¤ 1: ä¸Šä¼ ä¸€ä¸ªè§†é¢‘æ–‡ä»¶
æ­¥éª¤ 2: è¾“å…¥é—®é¢˜ï¼Œå¦‚"è§†é¢‘ä¸­å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ"
æ­¥éª¤ 3: ç‚¹å‡»å‘é€
```

## å‘½ä»¤è¡Œå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|--------|
| `--model_path` | bmodel æ–‡ä»¶è·¯å¾„ï¼ˆå¿…éœ€ï¼‰ | - |
| `--config_path` | é…ç½®æ–‡ä»¶ç›®å½• | `../config` |
| `--devid` | TPU è®¾å¤‡ ID | `0` |
| `--video_ratio` | è§†é¢‘åƒç´ æ¯”ä¾‹ | `0.25` |
| `--server_name` | æœåŠ¡å™¨åœ°å€ | `0.0.0.0` |
| `--server_port` | æœåŠ¡å™¨ç«¯å£ | `7860` |
| `--inbrowser` | è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ | `False` |

## æ”¯æŒçš„æ–‡ä»¶æ ¼å¼

### å›¾ç‰‡æ ¼å¼
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- BMP (.bmp)
- WebP (.webp)

### è§†é¢‘æ ¼å¼
- MP4 (.mp4)
- AVI (.avi)
- MOV (.mov)
- MKV (.mkv)
- FLV (.flv)
- WMV (.wmv)

## æ€§èƒ½è¯´æ˜

### æ¨¡å‹é™åˆ¶
- **æœ€å¤§åºåˆ—é•¿åº¦**: 2048 tokens
- **å›¾ç‰‡æœ€å¤§å°ºå¯¸**: 768x768 åƒç´ 
- **è§†é¢‘æ—¶é•¿**: æœ€é•¿ 12 ç§’ï¼ˆ1fpsï¼‰
- **è§†é¢‘é»˜è®¤åˆ†è¾¨ç‡**: ä¸ºå›¾ç‰‡çš„ 1/4

### Token è®¡ç®—
- **å›¾ç‰‡ Token** = é•¿ Ã— å®½ Ã· 32 Ã· 32
  - ä¾‹å¦‚ï¼š768Ã—768 å›¾ç‰‡ = 576 tokens
- **è§†é¢‘ Token** = æ¯ä¸¤å¸§å ç”¨ 144 tokens
  - ä¾‹å¦‚ï¼š20ç§’è§†é¢‘ï¼ˆ20å¸§ï¼‰= 1440 tokens

## æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ‰¾ä¸åˆ° chat.cpython*.so

**é”™è¯¯ä¿¡æ¯**ï¼š
```
ImportError: cannot import name 'chat' from 'pipeline'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
cd models/Qwen3_VL/python_demo
mkdir -p build && cd build
cmake .. && make
cp *cpython* ..
```

### é—®é¢˜ 2: pybind11 ç›¸å…³é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
pip3 install pybind11
```

### é—®é¢˜ 3: å›¾ç‰‡/è§†é¢‘ä¸Šä¼ å¤±è´¥

**å¯èƒ½åŸå› **ï¼š
- æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ
- æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶
- æ–‡ä»¶è·¯å¾„åŒ…å«ç‰¹æ®Šå­—ç¬¦

**è§£å†³æ–¹æ¡ˆ**ï¼šæ£€æŸ¥æ–‡ä»¶æ ¼å¼å’Œå¤§å°ï¼Œä½¿ç”¨æ”¯æŒçš„æ ¼å¼ã€‚

### é—®é¢˜ 4: æ¨ç†é€Ÿåº¦æ…¢

**å¯èƒ½åŸå› **ï¼š
- TPU é¢‘ç‡è¿‡ä½
- æ¨¡å‹æœªå®Œå…¨åŠ è½½
- å…¶ä»–è¿›ç¨‹å ç”¨ TPU

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥ TPU çŠ¶æ€
bm-smi

# è°ƒæ•´ TPU é¢‘ç‡ï¼ˆéœ€è¦ root æƒé™ï¼‰
echo "setr tpll_clock 750000000" > /sys/kernel/debug/top/clock
echo "setr mpll_clock 1800000000" > /sys/kernel/debug/top/clock
```

## é«˜çº§åŠŸèƒ½

### 1. è¿œç¨‹è®¿é—®

é»˜è®¤ç›‘å¬ `0.0.0.0:7860`ï¼Œå¯é€šè¿‡å±€åŸŸç½‘è®¿é—®ã€‚å¦‚éœ€å…¬ç½‘è®¿é—®ï¼Œå»ºè®®ä½¿ç”¨åå‘ä»£ç†æˆ– VPNã€‚

### 2. å¤šç”¨æˆ·å¹¶å‘

é»˜è®¤é˜Ÿåˆ—å¤§å°ä¸º 20ï¼Œå¯åœ¨ä»£ç ä¸­è°ƒæ•´ï¼š
```python
demo.queue(max_size=20).launch(...)
```

### 3. è‡ªå®šä¹‰æ ·å¼

ç¼–è¾‘ `web_demo_gradio.py` ä¸­çš„ `custom_css` å˜é‡ã€‚

## é¡¹ç›®ç»“æ„

```
models/Qwen3_VL/web_demo/
â”œâ”€â”€ README.md              # æœ¬æ–‡æ¡£
â”œâ”€â”€ requirements.txt       # Python ä¾èµ–
â”œâ”€â”€ run_demo.sh           # å¯åŠ¨è„šæœ¬
â””â”€â”€ web_demo_gradio.py    # ä¸»ç¨‹åº

ä¾èµ–ï¼š
â””â”€â”€ ../python_demo/
    â”œâ”€â”€ chat.cpython*.so  # ç¼–è¯‘åçš„ runtime æ¨¡å—
    â”œâ”€â”€ pipeline.py       # æ ¸å¿ƒæ¨ç†é€»è¾‘
    â””â”€â”€ chat.cpp          # Cython æºç 
```

## æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gradio Web Interface        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         Qwen3VLWebDemo              â”‚
â”‚  - æ¶ˆæ¯æ ¼å¼åŒ–                         â”‚
â”‚  - è¾“å…¥å¤„ç†                          â”‚
â”‚  - æµå¼ç”Ÿæˆ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         chat.Qwen3_VL (C++)         â”‚
â”‚  - TPU Runtime                       â”‚
â”‚  - Vision Encoder (ViT)             â”‚
â”‚  - LLM Inference                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         BM1684X/BM1688 TPU           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å‚è€ƒèµ„æº

- [Qwen3-VL Model Card](https://www.modelscope.cn/models/Qwen/Qwen3-VL-4B-Instruct)
- [TPU-MLIR GitHub](https://github.com/sophgo/tpu-mlir)
- [Gradio Documentation](https://www.gradio.app/docs)

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª TPU-MLIR çš„ 2-Clause BSD è®¸å¯è¯ï¼Œè¯¦è§ä¸»é¡¹ç›®ã€‚

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

---

**Sophgo Technologies Inc.**
